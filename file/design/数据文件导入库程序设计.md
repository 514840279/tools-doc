# data-file 文档

因为一些人对数据库的sqload，操作不熟悉，为防止操作不当导致数据库错误，

又因为其他内存不足原因导致数据文件打开不了等情况，

现在开发一套管理平台提供用户可以在平台上预览文件头几行数据，

快速配置并生成表，完成后自动将文件数据导入到数据库中


#### 1. 文件格式应该支持的有

```
.xsl 	.xslx	
.csv	.txt	

//.xml
//.json
//.data
```

#### 2.工作流程


1. 用户采用配置文件将数据文件的路径填入，
2. 用户启动应用，打开浏览器访问平台
3. 第一步用户选择要进行导入的数据文件，跳转11 如果没有数据 跳转 4

4. 平台展示出来数据文件的预览数据，
5. 用户看到预览数据后可以根据展示的数据进行配置文件的信息，包括跳过空行，首行为标题，分割符，限定符，特殊的字段可以允许进行格式化操作，比如日期，带特殊符号的等操作
6. 用户配置好文件信息时 可以看到二维表格展示的信息了，这时保存数据将配置的文件信息和解析后标题信息和格式化信息一并保存到文件字段表
7. 进行下一项配置选择要进行导入的表，如果没有现存的表需要进行表生成操作 create table 
8. 选择完要导入的表进行下一步配置关系映射，文件和表中各字段的关系，
9. 保存映射关系，等待系统后台进行数据处理
10. 数据文件 逐条记录进行执行，并更新文件的数据量，成功数错误数，错误文件要进入记录操作

11. 页面显示执行结果，提醒用户后续修改操作， 提供可 点击按键 跳到4 
 
 
 
 
#### 3.详细流程

###### 1. 配置文件

系统采用java 语言 jdk1.8版本 spring-boot 框架
该框架下配置文件位于.jar文件相同的位置 ，即程序外部配置文件
配置文件共有四个

|用途|文件名|
|-|-|
|管理数据链接池|application-hikari.yml	|
|mybatis配置|application-mybatis.yml	|
|数据库链接|application-mysql.yml		|
|平台其他配置|application-user.yml		|


这里说明配置文件

user中仅有三个参数 user.readfile控制扫描操作，user.file-dir和user.error-dir 这两个参数分别配置数据文件的路径和对应错误信息的导出路径

mysql中数据库的地址应当确认无误后继续下一步操作


###### 2. 用户启动应用
启动命令 
```
cd /jar文件夹中
java -jar data-file-1.0.jar
```

程序立即启动，启动后读取user.readfile，readfile为true立即进入文件扫描模式，
该模式下是在用户配置了user.dir后进行操作的，
程序读取到 user.dir 后扫描该文件夹中所有的文件信息并记录到表 sys_load_file_info 中
改表记录了文件的路径，名称，文件类型，文件大小，
如果有文件夹将继续读取文件夹中的文件直到全部文件处理完成，文件如果太多，系统将一直在扫描阶段，请耐心等待


###### 3. 第一步用户选择要进行导入的数据文件

用户登录平台 
http://ip:18020

默认展示列表页面 当用户点击某一数据的操作时跳转到处理页面



###### 4. 平台展示出来数据文件的预览数据，

默认展示文件中前十行数据，同时显示配置项，文件分割符，限定符，是否首行标题，跳过前多少行，

后台解析文件判断文件类型读取不同文件类型的数据进行解析不同的格式的数据，返回到页面上 默认解析出来的数据是二维数据，以后会增加json格式的数据

对数据的要求文件应以utf-8为标准字符格式，数据应以每一行为一个数据单位，


###### 5. 用户看到预览数据后可以根据展示的数据进行配置文件的信息

跳过多少行，变更时触发重新读取文件 跳过的行数 ~ 跳过行数+十行展示

字段默认以A_1,A_2 ...命名，当首行是标题时替换首行为字段的名称

分割符号和限定符号改变时，处理字段内容




###### 6. 用户配置好文件信息时
用户确定配置信息没有问题时 需要点击按钮 “确认配置信息" 来保持配置信息实例化，

点击 确认后后台判断改文件的配置信息是否存在，存在的先清除，然后进行整体保存，

保存成功后返回给页面提示消息 “配置信息修改成功。”



###### 7. 进行下一项配置选择要进行导入的表
用户配置完信息点击下一项时，此时进入到表选择页面，

页面展示的是全部的表信息，用户如果进行点击表名称时，数据有选中效果，

用户点击下一项时 后台查询表信息和表字段信息，并将信息数据保留到pinia中将数据带入下一页

如果没有对应要导入的表信息，应当提供一个按键“创建表” 
创建表信息应根据文件的字段信息生成预览建表语句，并允许修改，

后台创建的表格信息 同时记录到配置表中 sys_dbms_tabs_table_info 和 sys_dbms_tabs_cols_info


###### 8. 选择完要导入的表进行下一步配置关系映射
页面左侧 展示文件的文件，文件字段信息，表、表字段信息
    右侧展示关系映射结构，

用户点选文件字段和表字段，确定后 将两者构造成关系映射并展示在右边，



###### 9. 保存映射关系
当用户确认全部的关系映射信息无误后 点击“确认配置信息” 来保持配置信息实例化，

点击 确认后后台判断改文件的配置信息是否存在，存在的先清除，然后进行整体保存，

保存成功后返回给页面提示消息 “配置信息修改成功。”


###### 10. 数据文件 导入
保存成功后后台另开一个线程执行导入数据任务，

获取文件信息，映射关系，
创建导入日志信息，逐条记录进行执行，

并更新日志的 文件数据量，成功数错误数，错误文件要进入记录操作

日志信息 状态
STRAT = "准备", RUNNING = "运行中", STOPED = "停止", END = "结束", CLOSED = "关闭", ERROR = "有错误";

日志初始化为准备态，当后台程序读取到准备态的任务时，进行导入数据这时为运行中，有错误的信息执行完导出错误和错误文件更新为有错误，
正常执行没有错误的为结束态，

运行中 页面可以选择停止，和重启，
重启为关闭当前最新日志，新建日志记录为准备态的数据，
运行中程序有意外停止的情况，程序重启后首先运行运行中的，接着记录的状态继续执行，
当运行中的执行完毕后再执行准备态的任务，

停止的页面可以选择重启和继续
继续，状态改为准备，等待系统调用

重启 只有运行中和停止态需要改为关闭太，准备态不需要关闭，也不需要新建，结束、关闭、有错误态不需要关闭，需要新建，


###### 11. 页面显示执行结果

保存成功后页面转到结果显示页面，页面显示每次执行的日志信息  包括 文件数据量，成功数错误数，错误文件
执行中的信息可以实时提示，提醒用户后续修改操作， 

提供可 点击按键 跳到4 




## 导入处理
系统默认开启多线程处理，最多不应超过10个，每个线程处理一个文件，保证系统内存不会溢出
系统默认配置每千条记录提交一次，即导入数据应以批处理 sql batch 导入，
系统实行边读边写方式，即读取文件达到千行时提交一次然后释放掉前面读取到内存中的数据，继续处理读取知道文件全部读完，关闭文件读取功能，



###### 处理流程
1. 读取配置信息
2. 创建文件对象
3. 获取链接池中jdbc链接对象
4. 获取默认系统配置 千条 提交一次
5. 创建临时变量 统计读取行数，错误信息、提交的行数，临时行数
6. 创建sql batch 语句
7. 打开文件 
8. 循环读取文件行，判断达到每 千条数据
9. 提交数据，
10. 假如提交错误，修改临时配置/10 即每百条提交一次，若还有错误继续/10, 直到一条时找到错误行，记录错误信息到错误文件中，
11. 恢复千条提交一次，继续读文件写入库
12. 文件读完，提交剩余数据，关闭文件，
13. 修改文件 错误的 标记有错误，没有的标记结束态
















